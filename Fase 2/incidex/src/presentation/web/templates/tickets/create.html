{% extends "_layouts/base_private.html" %}
{% set title = "Crear Ticket" %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/tickets.css') }}">
<style>
  /* Chips de archivos a adjuntar */
  .file-list { list-style:none; padding:0; margin:.35rem 0 0; display:flex; flex-wrap:wrap; gap:8px; }
  .file-chip { display:inline-flex; align-items:center; gap:6px; padding:.35rem .55rem; border-radius:999px;
               background:#eef4ff; border:1px solid #cfe0ff; color:#0b2f69; font-size:.9rem; }
  .file-chip .remove { display:inline-flex; align-items:center; justify-content:center; width:18px; height:18px;
                       border-radius:50%; background:#0b2f69; color:#fff; font-weight:700; line-height:1;
                       cursor:pointer; border:0; }
  .file-chip .remove:hover { filter:brightness(1.1); }

  /* Select deshabilitado (solo visual) */
  .input.-readonly { background:#f7f7f9; color:#6b7280; pointer-events:none; }
</style>
{% endblock %}

{% block content %}
<section class="page-hero -sm">
  <div class="container">
    <h1 class="page-hero__title">Crear Ticket</h1>
    <p class="lead">Crea tu ticket de manera rapida e inteligente</p>
  </div>
</section>

<form class="ticket-wizard container" id="ticketForm"
      method="post" action="{{ url_for('tickets.create_post') }}"
      enctype="multipart/form-data" novalidate>
  {{ form.csrf_token }}

  <!-- Fase 1 -->
  <section class="step is-open" data-step="1">
    <button class="step__head" type="button">
      <span>Información Básica del Ticket</span><span class="chev">▾</span>
    </button>
    <div class="step__body">
      <p class="muted">Ingresa los datos principales…</p>

      <div class="grid-2 gap-md">
        <div class="form__group">
          <label for="title">Título del ticket</label>
          <input id="title" name="subject" type="text" class="input" placeholder="Ej: No puedo iniciar sesión en correo" required>
        </div>
        <div></div>

        <div class="form__group grid-col-span-2">
          <label for="description">Descripción detallada</label>
          <textarea id="description" name="details" class="textarea" rows="6"
            placeholder="Describe con detalle…" required></textarea>
        </div>

        <!-- Adjuntos con previsualización y eliminar -->
        <div class="form__group grid-col-span-2">
          <div class="form__row between">
            <label>Archivos adjuntos</label>
            <label class="btn btn-dark btn-sm" for="files">Adjuntar</label>
            <input id="files" name="files" type="file" multiple hidden>
          </div>
          <ul id="fileList" class="file-list" aria-live="polite"></ul>
        </div>
      </div>

      <div class="step__actions">
        <button type="button" class="btn btn-primary js-next">Siguiente</button>
      </div>
    </div>
  </section>

  <!-- Fase 2 -->
  <section class="step" data-step="2">
    <button class="step__head" type="button">
      <span>Clasificación del ticket</span><span class="chev">▾</span>
    </button>
    <div class="step__body">
      <p class="muted">Selecciona cómo clasificar la incidencia.</p>
      <div class="grid-2 gap-md">
        <div class="form__group">
          <label for="category">Categoría</label>
          <select id="category" name="category_id" class="input" required>
            <option value="">Selecciona…</option>
            {% for c in cats.categories %}
              <option value="{{ c.id }}">{{ c.name }}</option>
            {% endfor %}
          </select>
        </div>
        <div class="form__group">
          <label for="area">Área / Departamento</label>
          <select id="area" name="department_id" class="input" required>
            <option value="">Selecciona…</option>
            {% for d in cats.departments %}
              <option value="{{ d.id }}">{{ d.name }}</option>
            {% endfor %}
          </select>
        </div>
        <div class="form__group">
          <label for="priority">Prioridad</label>
          <select id="priority" name="priority_id" class="input" required>
            <option value="">Selecciona…</option>
            {% for p in cats.priorities %}
              <option value="{{ p.id }}">{{ p.name }}</option>
            {% endfor %}
          </select>
        </div>
      </div>
      <div class="step__actions">
        <button type="button" class="btn btn-outline js-prev">Atrás</button>
        <button type="button" class="btn btn-primary js-next">Siguiente</button>
      </div>
    </div>
  </section>

  <!-- Fase 3 -->
  <section class="step" data-step="3">
    <button class="step__head" type="button">
      <span>Datos del solicitante y asignación</span><span class="chev">▾</span>
    </button>
    <div class="step__body">
      <p class="muted">Define solicitante y asignación inicial.</p>
      <div class="grid-2 gap-md">
        <div class="form__group">
          <label for="requester">Usuario solicitante</label>
          <!-- Usuario solicitante -->
          <input id="requester" class="input -readonly" value="{{ current_user.name }}" readonly>
        </div>

        <!-- Asignar a: deshabilitado + hidden para enviar -->
        <div class="form__group">
          <label for="assignee_display">Asignar a</label>
          <select id="assignee_display" class="input -readonly" disabled>
            <option value="0">— Sin asignar —</option>
            {% for a in cats.analysts %}
              <option value="{{ a.id }}"
                      {% if a.id == 0 %}selected{% endif %}
                      data-dept="{{ a.department_id if a.department_id is defined else '' }}">
                {{ a.full_name }}
              </option>
            {% endfor %}
          </select>
          <!-- el valor real que se envía -->
          <input type="hidden" id="assignee" name="assignee_id" value="0">
          <small class="muted">Se autocompletará según el Área/Departamento seleccionado.</small>
        </div>

        <div class="form__group">
          <label for="initial_status">Estado inicial</label>
          <!-- Estado inicial -->
          <input id="initial_status" class="input -readonly" value="Nuevo" readonly>
        </div>
      </div>
      <div class="step__actions">
        <button type="button" class="btn btn-outline js-prev">Atrás</button>
        <button type="button" class="btn btn-primary js-next">Siguiente</button>
      </div>
    </div>
  </section>

  <!-- Fase 4 -->
  <section class="step" data-step="4">
    <button class="step__head" type="button">
      <span>Confirmación y envío</span><span class="chev">▾</span>
    </button>
    <div class="step__body">
      <p class="muted">Revisa antes de enviar.</p>
      <div class="card">
        <div class="grid-2 gap-md">
          <div>
            <strong>Resumen</strong>
            <div class="summary" id="summaryBox"></div>
          </div>
        </div>
      </div>
      <div class="step__actions">
        <button type="button" class="btn btn-outline js-prev">Atrás</button>
        <button type="submit" class="btn btn-dark">Enviar</button>
      </div>
    </div>
  </section>
</form>
{% endblock %}

{% block extra_js %}
<script src="{{ url_for('static', filename='js/tickets.js') }}"></script>
{% endblock %}

