{% extends "_layouts/base_private.html" %}
{% set title = ticket.code ~ " · " ~ ticket.title %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/ticket_detail.css') }}">
{% endblock %}

{% block content %}
<section class="page-hero -sm">
  <div class="container">
    <h1 class="page-hero__title">{{ ticket.code }}</h1>
    <p class="lead">{{ ticket.title }}</p>
  </div>
</section>

<section class="section">
  <div class="container ticket-detail">

    <!-- Meta -->
    <div class="meta">
      <div><strong>Estado:</strong> <span class="badge s-{{ ticket.status_name|lower }}">{{ ticket.status_name }}</span></div>
      <div><strong>Prioridad:</strong> <span class="badge p-{{ ticket.priority_name|lower }}">{{ ticket.priority_name }}</span></div>
      <div><strong>Categoría:</strong> {{ ticket.category_name or "—" }}</div>
      <div><strong>Solicitante:</strong> {{ ticket.requester_name }}</div>
      <div><strong>Asignado a:</strong> {{ ticket.assignee_name or "—" }}</div>
      <div><strong>Creado:</strong> {{ ticket.created_at }}</div>
      <div><strong>Actualizado:</strong> {{ ticket.updated_at }}</div>
    </div>

    <div class="grid-2 gap-md">
      <!-- Conversación (col izquierda) -->
      <section class="card">
        <h3>Conversación</h3>
        <article class="ticket-body">
          <p>{{ ticket.description }}</p>
        </article>

        <ul class="comments">
          {% for c in comments %}
            <li>
              <div class="c-head">
                <strong>{{ c.author_name }}</strong>
                <span class="muted">{{ c.created_at }}</span>
              </div>
              <p>{{ c.body }}</p>
            </li>
          {% else %}
            <li class="muted">Sin comentarios.</li>
          {% endfor %}
        </ul>

        {% if can_act %}
        <form action="{{ url_for('tickets.comment', ticket_id=ticket.id) }}" method="post" class="comment-form">
          <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
          <textarea name="body" rows="3" class="textarea" placeholder="Escribe un comentario..."></textarea>
          <div class="right"><button class="btn btn-primary" type="submit">Agregar comentario</button></div>
        </form>
        {% endif %}
      </section>

      <div class="stack">
        {% if can_act %}

        <!-- ===== Cambio Estado ===== -->
        <section class="card" aria-label="Cambiar estado">
          <h3>Cambiar estado</h3>
          <form id="stateForm" action="{{ url_for('tickets.change_status', ticket_id=ticket.id) }}" method="post">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
            <input type="hidden" id="hidden_to_status_id" name="to_status_id">
            <input type="hidden" id="hidden_note" name="note">

            <div class="form__group">
              <label for="to_status_id_select"></label>
              <select id="to_status_id_select" class="input" required
                      data-prev="{{ current_status_id or '' }}">
                <option value="">Selecciona…</option>
                {% for s in statuses %}
                  <option value="{{ s.id }}" {{ 'selected' if current_status_id==s.id else '' }}>
                    {{ s.name }}
                  </option>
                {% endfor %}
              </select>
            </div>
            {# Sin botón; el modal se abre al cambiar el select #}
          </form>
        </section>

        <!-- ===== Asignar a ===== -->
        <section class="card" aria-label="Asignar a">
          <h3>Asignar a</h3>
          <form id="assignForm" action="{{ url_for('tickets.assign', ticket_id=ticket.id) }}" method="post">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
            <input type="hidden" id="hidden_assignee_id" name="assignee_id">
            <input type="hidden" id="hidden_assign_note" name="note">

            <div class="form__group">
              <label for="assignee_id_select">Seleccionar persona</label>
              <select id="assignee_id_select" class="input" required
                      data-prev="{{ current_assignee_id or '' }}">
                <option value="">— Selecciona —</option>
                {% for u in assignables %}
                  <option value="{{ u.id }}" {{ 'selected' if current_assignee_id==u.id else '' }}>
                    {{ u.full_name }}
                  </option>
                {% endfor %}
              </select>
            </div>
            {# Sin botón; el modal se abre al cambiar el select #}
          </form>
        </section>
        {% endif %}

        <!-- Adjuntos (debajo) -->
        <section class="card">
          <h3>Adjuntos</h3>
          <ul class="attachments">
            {% for a in attachments %}
              <li>
                <a class="link" href="{{ url_for('tickets.download', ticket_id=ticket.id, att_id=a.id) }}">{{ a.file_name }}</a>
                <span class="muted">({{ a.file_size }} bytes · {{ a.created_at }})</span>
              </li>
            {% else %}
              <li class="muted">Sin archivos.</li>
            {% endfor %}
          </ul>

          {% if can_act %}
          <form action="{{ url_for('tickets.upload', ticket_id=ticket.id) }}" method="post" enctype="multipart/form-data" class="upload-form">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
            <input id="fileInput" type="file" name="file" class="file-input-hidden" required>
            <label for="fileInput" class="btn btn-outline btn-file">Adjuntar archivo</label>
            <button class="btn btn-primary btn-upload" type="submit">Subir</button>
            <ul id="uploadFiles" class="file-list" aria-live="polite"></ul>
          </form>
          {% endif %}
        </section>
      </div>

    </div>

    <!-- Historial -->
    <section class="card">
      <h3>Historial</h3>
      <ol class="history">
        {% for h in history %}
          <li>
            <span class="muted">{{ h.created_at }}</span>
            <strong>{{ h.actor }}</strong> cambió estado
            {% if h.from_status %}de <em>{{ h.from_status }}</em>{% endif %}
            a <em>{{ h.to_status }}</em>
            {% if h.note %} — {{ h.note }}{% endif %}
          </li>
        {% else %}
          <li class="muted">Sin movimientos.</li>
        {% endfor %}
      </ol>
    </section>

  </div>
</section>

<!-- ========= Modal Nota (tipo Jira) ========= -->
<div id="noteModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="noteTitle" hidden>
  <div class="modal__backdrop"></div>
  <div class="modal__dialog">
    <header class="modal__header">
      <h3 id="noteTitle">Agregar nota al cambio de estado</h3>
      <button type="button" class="modal__close" aria-label="Cerrar">×</button>
    </header>
    <div class="modal__body">
      <p class="muted">Opcional: explica brevemente el motivo del cambio.</p>
      <input id="noteInput" type="text" class="input" placeholder="Motivo o comentario (opcional)">
    </div>
    <footer class="modal__footer">
      <button type="button" class="btn btn-outline modal__cancel">Cancelar</button>
      <button type="button" class="btn btn-primary modal__confirm">Confirmar cambio</button>
    </footer>
  </div>
</div>

<!-- ========= Modal Nota para Asignación ========= -->
<div id="assignModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="assignTitle" hidden>
  <div class="modal__backdrop"></div>
  <div class="modal__dialog">
    <header class="modal__header">
      <h3 id="assignTitle">Agregar nota a la reasignación</h3>
      <button type="button" class="modal__close" aria-label="Cerrar">×</button>
    </header>
    <div class="modal__body">
      <p class="muted">Opcional: explica brevemente el motivo del cambio de asignación.</p>
      <input id="assignNoteInput" type="text" class="input" placeholder="Motivo o comentario (opcional)">
    </div>
    <footer class="modal__footer">
      <button type="button" class="btn btn-outline assign__cancel">Cancelar</button>
      <button type="button" class="btn btn-primary assign__confirm">Confirmar reasignación</button>
    </footer>
  </div>
</div>


{% endblock %}

{% block extra_js %}
<script src="{{ url_for('static', filename='js/tickets_detail.js') }}"></script>
{% endblock %}
