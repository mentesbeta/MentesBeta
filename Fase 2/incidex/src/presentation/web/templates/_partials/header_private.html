<header class="site-header site-header--light" role="banner">
  <div class="container nav" aria-label="Barra principal privada">
    <!-- Brand -->
    <a class="brand brand--row" href="{{ url_for('tickets.dashboard') }}">
      <img src="{{ url_for('static', filename='img/logo_incidex.png') }}"
           alt="Incidex" class="brand__logo">
    </a>

    <!-- Menú centrado -->
    <nav class="nav-items nav-items--center" aria-label="Navegación del panel">
      <a class="nav-link {{ 'is-active' if request.endpoint=='tickets.dashboard' else '' }}"
         href="{{ url_for('tickets.dashboard') }}">Inicio</a>

      <a class="nav-link {{ 'is-active' if request.endpoint=='tickets.mine' else '' }}"
         href="{{ url_for('tickets.mine') }}">Mis Tickets</a>

      <a class="nav-link {{ 'is-active' if request.endpoint=='tickets.create' else '' }}"
         href="{{ url_for('tickets.create') }}">Nuevo Ticket</a>
    </nav>

    <!-- Lado derecho: campana + usuario -->
    <div class="nav-right">
      <!-- Campana de notificaciones -->
      <div class="notif-menu">
        <button class="notif-btn" type="button" id="notifToggle" aria-haspopup="true" aria-expanded="false">
          <svg class="notif-icon" viewBox="0 0 24 24" aria-hidden="true">
            <path d="M12 2a7 7 0 0 1 7 7v4l1.29 1.29a1 1 0 0 1-.7 1.71H4.41a1 1 0 0 1-.7-1.71L5 13V9a7 7 0 0 1 7-7zm-2 17a2 2 0 0 0 4 0h-4z"
                  fill="currentColor" />
          </svg>
          {% if header_notifications_unread %}
            <span class="notif-badge">{{ header_notifications_unread }}</span>
          {% endif %}
        </button>

        <div class="notif-dropdown" id="notifDropdown" hidden>
          <div class="notif-dropdown__header">
            <span>Notificaciones</span>
            {% if header_notifications_unread %}
              <form method="post" action="{{ url_for('tickets.notifications_read_all') }}" class="notif-header-form">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <button class="notif-link" type="submit">Marcar como leídas</button>
              </form>
            {% endif %}
          </div>

          <ul class="notif-dropdown__list">
            {% if header_notifications %}
              {% for n in header_notifications %}
                <li>
                  <div class="notif-msg">{{ n.message }}</div>
                  <div class="notif-meta">
                    <span class="notif-date">{{ n.created_at }}</span>
                    <a class="notif-link" href="{{ url_for('tickets.detail', ticket_id=n.ticket_id) }}">
                      Ver ticket
                    </a>
                  </div>
                </li>
              {% endfor %}
            {% else %}
              <li class="notif-empty">Sin notificaciones</li>
            {% endif %}
          </ul>
        </div>
      </div>

      <!-- Usuario / login -->
      {% if current_user and current_user.is_authenticated %}
        <div class="user-menu" x-data>
          <button class="user-btn" type="button" aria-haspopup="menu" aria-expanded="false">
            <img class="user-btn__icon" alt="" src="{{ url_for('static', filename='img/icon_user.svg') }}">
            <span>
              {{ current_user.names_worker }} {{ current_user.last_name }}
              {% if current_user.department and current_user.department.name %}
                — {{ current_user.department.name }}
              {% endif %}
            </span>
            <svg viewBox="0 0 24 24" width="18" height="18" aria-hidden="true">
              <path d="M7 10l5 5 5-5z" fill="currentColor"></path>
            </svg>
          </button>

          <div class="user-dropdown" role="menu" hidden>
            <form action="{{ url_for('auth.logout') }}" method="post">
              <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
              <button type="submit" class="dropdown-item">Cerrar sesión</button>
            </form>
          </div>
        </div>
      {% else %}
        <a class="login-btn" href="{{ url_for('auth.login') }}">
          <img class="login-btn__icon" alt="" src="{{ url_for('static', filename='img/icon_user.svg') }}">
          <span>Login</span>
        </a>
      {% endif %}
    </div>
  </div>
</header>


<script>
  (function () {
    // ===== Menú usuario =====
    const menu = document.querySelector('.user-menu');
    if (menu) {
      const btn = menu.querySelector('.user-btn');
      const drop = menu.querySelector('.user-dropdown');

      const toggle = (open) => {
        if (!drop) return;
        if (open === undefined) drop.hidden = !drop.hidden;
        else drop.hidden = !open;
        btn.setAttribute('aria-expanded', String(!drop.hidden));
      };

      btn?.addEventListener('click', (e) => {
        e.stopPropagation();
        toggle();
      });

      document.addEventListener('click', (e) => {
        if (!menu.contains(e.target)) toggle(false);
      });
    }

    // ===== Notificaciones =====
    const notifBtn = document.getElementById('notifToggle');
    const notifDrop = document.getElementById('notifDropdown');

    if (notifBtn && notifDrop) {
      const toggleNotif = (open) => {
        if (open === undefined) notifDrop.hidden = !notifDrop.hidden;
        else notifDrop.hidden = !open;
        notifBtn.setAttribute('aria-expanded', String(!notifDrop.hidden));
      };

      notifBtn.addEventListener('click', (e) => {
        e.stopPropagation();
        toggleNotif();
      });

      document.addEventListener('click', (e) => {
        if (!notifDrop.contains(e.target) && e.target !== notifBtn) {
          toggleNotif(false);
        }
      });
    }
  })();
</script>
